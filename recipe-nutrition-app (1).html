<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecipeFlow - Your Personal Nutrition Hub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç≥</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5f3d;
            --primary-light: #2d8659;
            --primary-dark: #0f3d28;
            --accent: #e67e22;
            --accent-light: #f39c12;
            --bg: #faf8f5;
            --surface: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #e8e4df;
            --shadow: rgba(26, 95, 61, 0.08);
            --error: #e74c3c;
            --success: #27ae60;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Crimson Pro', serif;
            font-weight: 700;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--primary-dark);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: "üç≥";
            font-size: 2rem;
        }

        .nav-menu {
            list-style: none;
            padding: 1.5rem 0;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary-light);
            color: white;
            border-left: 3px solid var(--accent);
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            max-width: 1400px;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: var(--accent-light);
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 1.5rem;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .recipe-card {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .recipe-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        }

        .recipe-content {
            padding: 1.25rem;
        }

        .recipe-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.75rem;
        }

        .recipe-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .recipe-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 2rem;
            color: var(--primary-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.25rem;
        }

        .meal-plan-grid {
            display: grid;
            gap: 1rem;
        }

        .day-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .day-header {
            font-size: 1.5rem;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .meal-slot {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
        }

        .meal-type {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .badge-primary {
            background: var(--primary-light);
            color: white;
        }

        .badge-accent {
            background: var(--accent);
            color: white;
        }

        .nutrition-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .nutrition-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .nutrition-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nutrition-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .search-bar {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .quick-food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .shopping-list {
            list-style: none;
        }

        .shopping-list li {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .shopping-list li:last-child {
            border-bottom: none;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .simple-recipe-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 200;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
                z-index: 150;
                width: 80%;
                max-width: 300px;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-overlay.open {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: 5rem 1rem 1rem 1rem;
            }

            .recipe-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal {
                width: 95%;
                max-height: 85vh;
            }
        }

        @media print {
            /* Hide everything that shouldn't print */
            .sidebar,
            .main-content,
            .action-buttons,
            .close-btn,
            .page-header,
            .search-bar,
            .recipe-grid,
            .nav-menu {
                display: none !important;
            }

            /* Reset body and html for printing */
            body, html {
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                background: white !important;
            }

            /* Show and position the modal overlay */
            .modal-overlay {
                position: static !important;
                background: transparent !important;
                display: block !important;
            }

            /* Style the modal for print */
            .modal {
                position: static !important;
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                max-width: 19cm !important;
                width: 100% !important;
                padding: 1cm !important;
                margin: 0 auto !important;
                background: white !important;
                border-radius: 0 !important;
            }

            /* A4 page setup */
            @page {
                size: A4 portrait;
                margin: 1cm;
            }

            /* Make image smaller for print */
            .modal img {
                max-width: 8cm !important;
                max-height: 6cm !important;
                object-fit: contain !important;
                display: block;
                margin: 0 auto 0.5cm !important;
            }

            /* Optimize typography for print */
            .modal-title {
                font-size: 1.5rem !important;
                margin-bottom: 0.3cm !important;
                color: #000 !important;
            }

            .modal-header {
                margin-bottom: 0.5cm !important;
                page-break-after: avoid;
                border: none !important;
            }

            .recipe-meta {
                font-size: 0.9rem !important;
                margin-bottom: 0.5cm !important;
                page-break-after: avoid;
                color: #333 !important;
            }

            /* Nutrition card */
            .card {
                padding: 0.5cm !important;
                margin-bottom: 0.5cm !important;
                page-break-inside: avoid;
                background: #f5f5f5 !important;
                border-radius: 4px !important;
            }

            .nutrition-summary {
                gap: 0.3cm !important;
            }

            .nutrition-item {
                padding: 0.3cm !important;
                background: white !important;
            }

            .nutrition-value {
                font-size: 1.2rem !important;
                color: #000 !important;
            }

            .nutrition-label {
                font-size: 0.8rem !important;
                color: #666 !important;
            }

            /* Section headings */
            h3 {
                font-size: 1.2rem !important;
                margin-top: 0.5cm !important;
                margin-bottom: 0.3cm !important;
                page-break-after: avoid;
                color: #000 !important;
            }

            /* Lists */
            ul, ol {
                padding-left: 0.8cm !important;
            }

            li {
                padding: 0.15cm 0 !important;
                border-bottom: 0.5px solid #ddd !important;
                font-size: 0.9rem !important;
                page-break-inside: avoid;
                color: #000 !important;
            }

            ol li {
                margin-bottom: 0.3cm !important;
                line-height: 1.4 !important;
            }

            /* Paragraphs */
            p {
                font-size: 0.9rem !important;
                line-height: 1.4 !important;
                color: #000 !important;
            }

            /* Sections for folding */
            .ingredients-section {
                page-break-after: auto;
            }

            .steps-section {
                page-break-before: auto;
            }

            /* Make servings input look clean in print */
            input[type="number"] {
                border: 1px solid #ccc !important;
                padding: 2px 4px !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Ensure backgrounds print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Initialize Supabase client
        const SUPABASE_URL = 'https://hebuaabantmnfdxxkaif.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_xzVfo0l-eLpkP4TuUy17KQ_kLLUUScF';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Utility functions
        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };

        const getNextTwoWeeks = () => {
            const dates = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            // Find the most recent Monday (could be today or in the past)
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday is 0, Monday is 1
            const thisMonday = new Date(today);
            thisMonday.setDate(today.getDate() - daysFromMonday);
            
            // Generate 14 days starting from this Monday
            for (let i = 0; i < 14; i++) {
                const date = new Date(thisMonday);
                date.setDate(thisMonday.getDate() + i);
                dates.push(date);
            }
            return dates;
        };

        const getDayName = (date) => {
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        };

        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [recipes, setRecipes] = useState([]);
            const [quickFoods, setQuickFoods] = useState([]);
            const [mealPlans, setMealPlans] = useState([]);
            const [dailyExtras, setDailyExtras] = useState([]);
            const [nutritionGoals, setNutritionGoals] = useState(null);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            // Load data from Supabase
            const loadRecipes = async () => {
                const { data, error } = await supabase.from('recipes').select('*');
                if (data) setRecipes(data);
            };

            const loadQuickFoods = async () => {
                const { data, error } = await supabase.from('quick_foods').select('*');
                if (data) setQuickFoods(data);
            };

            const loadMealPlans = async () => {
                const { data, error } = await supabase.from('meal_plans').select('*');
                if (data) setMealPlans(data);
            };

            const loadDailyExtras = async () => {
                const { data, error } = await supabase.from('daily_extras').select('*');
                if (data) setDailyExtras(data);
            };

            const loadNutritionGoals = async () => {
                try {
                    const { data, error } = await supabase.from('nutrition_goals').select('*').limit(1);
                    
                    if (error) {
                        console.error('Error loading nutrition goals:', error);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        setNutritionGoals(data[0]);
                    } else {
                        // No goals exist, create default
                        const { data: newGoal, error: insertError } = await supabase.from('nutrition_goals').insert({
                            calories: 2000,
                            protein: 150,
                            carbs: 250,
                            fat: 65,
                            fiber: 30,
                            sugar: 50
                        }).select();
                        
                        if (newGoal && newGoal.length > 0) {
                            setNutritionGoals(newGoal[0]);
                        }
                    }
                } catch (err) {
                    console.error('Exception loading nutrition goals:', err);
                }
            };

            useEffect(() => {
                loadRecipes();
                loadQuickFoods();
                loadMealPlans();
                loadDailyExtras();
                loadNutritionGoals();
            }, []);

            const renderPage = () => {
                switch (currentPage) {
                    case 'dashboard':
                        return <Dashboard 
                            recipes={recipes}
                            mealPlans={mealPlans}
                            dailyExtras={dailyExtras}
                            nutritionGoals={nutritionGoals}
                        />;
                    case 'recipes':
                        return <Recipes 
                            recipes={recipes}
                            setRecipes={setRecipes}
                            reload={loadRecipes}
                            reloadMealPlans={loadMealPlans}
                        />;
                    case 'meal-planning':
                        return <MealPlanning 
                            recipes={recipes}
                            mealPlans={mealPlans}
                            reload={loadMealPlans}
                        />;
                    case 'quick-foods':
                        return <QuickFoods 
                            quickFoods={quickFoods}
                            reload={loadQuickFoods}
                        />;
                    case 'shopping-list':
                        return <ShoppingList 
                            recipes={recipes}
                            mealPlans={mealPlans}
                        />;
                    case 'nutrition-goals':
                        return <NutritionGoals 
                            goals={nutritionGoals}
                            reload={loadNutritionGoals}
                        />;
                    default:
                        return <Dashboard />;
                }
            };

            return (
                <div className="app-container">
                    <button 
                        className="mobile-menu-toggle"
                        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                    >
                        ‚ò∞
                    </button>
                    <div 
                        className={`sidebar-overlay ${mobileMenuOpen ? 'open' : ''}`}
                        onClick={() => setMobileMenuOpen(false)}
                    ></div>
                    <Sidebar 
                        currentPage={currentPage} 
                        setCurrentPage={(page) => {
                            setCurrentPage(page);
                            setMobileMenuOpen(false);
                        }}
                        mobileOpen={mobileMenuOpen}
                    />
                    <div className="main-content">
                        {renderPage()}
                    </div>
                </div>
            );
        }

        // Sidebar Component
        function Sidebar({ currentPage, setCurrentPage, mobileOpen }) {
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                { id: 'recipes', label: 'Recipes', icon: 'üìñ' },
                { id: 'meal-planning', label: 'Meal Planning', icon: 'üìÖ' },
                { id: 'quick-foods', label: 'Quick Foods', icon: 'üç™' },
                { id: 'shopping-list', label: 'Shopping List', icon: 'üõí' },
                { id: 'nutrition-goals', label: 'Nutrition Goals', icon: 'üéØ' },
            ];

            return (
                <nav className={`sidebar ${mobileOpen ? 'mobile-open' : ''}`}>
                    <div className="sidebar-header">
                        <div className="logo">RecipeFlow</div>
                    </div>
                    <ul className="nav-menu">
                        {menuItems.map(item => (
                            <li 
                                key={item.id}
                                className={`nav-item ${currentPage === item.id ? 'active' : ''}`}
                                onClick={() => setCurrentPage(item.id)}
                            >
                                <span>{item.icon}</span>
                                <span>{item.label}</span>
                            </li>
                        ))}
                    </ul>
                </nav>
            );
        }

        // Dashboard Component
        function Dashboard({ recipes, mealPlans, dailyExtras, nutritionGoals }) {
            const today = formatDate(new Date());
            const todaysMeals = mealPlans.filter(mp => mp.date === today);
            const todaysExtras = dailyExtras.filter(de => de.date === today);

            const calculateTodaysNutrition = () => {
                let totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };

                todaysMeals.forEach(meal => {
                    if (meal.data_type === 'recipe' && meal.recipe_id) {
                        const recipe = recipes.find(r => r.id === meal.recipe_id);
                        if (recipe && recipe.nutrition) {
                            totals.calories += recipe.nutrition.calories || 0;
                            totals.protein += recipe.nutrition.protein || 0;
                            totals.carbs += recipe.nutrition.carbs || 0;
                            totals.fat += recipe.nutrition.fat || 0;
                        }
                    }
                });

                todaysExtras.forEach(extra => {
                    totals.calories += extra.calories || 0;
                    totals.protein += extra.protein || 0;
                });

                return totals;
            };

            const nutrition = calculateTodaysNutrition();

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Dashboard</h1>
                        <p className="page-subtitle">Your nutrition overview for today</p>
                    </div>

                    <div className="dashboard-grid">
                        <div className="card">
                            <h2 style={{ marginBottom: '1rem' }}>Today's Nutrition</h2>
                            <div className="nutrition-summary">
                                <div className="nutrition-item">
                                    <div className="nutrition-value">{Math.round(nutrition.calories)}</div>
                                    <div className="nutrition-label">Calories</div>
                                    {nutritionGoals && (
                                        <div style={{ fontSize: '0.8rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                            / {nutritionGoals.calories} goal
                                        </div>
                                    )}
                                </div>
                                <div className="nutrition-item">
                                    <div className="nutrition-value">{Math.round(nutrition.protein)}g</div>
                                    <div className="nutrition-label">Protein</div>
                                    {nutritionGoals && (
                                        <div style={{ fontSize: '0.8rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                            / {nutritionGoals.protein}g goal
                                        </div>
                                    )}
                                </div>
                                <div className="nutrition-item">
                                    <div className="nutrition-value">{Math.round(nutrition.carbs)}g</div>
                                    <div className="nutrition-label">Carbs</div>
                                </div>
                                <div className="nutrition-item">
                                    <div className="nutrition-value">{Math.round(nutrition.fat)}g</div>
                                    <div className="nutrition-label">Fat</div>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h2 style={{ marginBottom: '1rem' }}>Today's Meals</h2>
                            {todaysMeals.length === 0 ? (
                                <p style={{ color: 'var(--text-light)' }}>No meals planned for today</p>
                            ) : (
                                todaysMeals.map((meal, idx) => {
                                    const recipe = meal.data_type === 'recipe' && meal.recipe_id
                                        ? recipes.find(r => r.id === meal.recipe_id)
                                        : null;
                                    
                                    return (
                                        <div key={idx} className="meal-slot">
                                            <div className="meal-type">{meal.meal_type}</div>
                                            <div style={{ fontWeight: '600' }}>
                                                {recipe ? recipe.name : meal.custom_text}
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            {todaysExtras.length > 0 && (
                                <div style={{ marginTop: '1rem' }}>
                                    <h3 style={{ fontSize: '1rem', marginBottom: '0.5rem' }}>Extras</h3>
                                    {todaysExtras.map((extra, idx) => (
                                        <div key={idx} style={{ fontSize: '0.9rem', color: 'var(--text-light)', marginBottom: '0.25rem' }}>
                                            {extra.name} - {extra.calories} cal, {extra.protein}g protein
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Recipes Component
        function Recipes({ recipes, setRecipes, reload, reloadMealPlans }) {
            const [showModal, setShowModal] = useState(false);
            const [editingRecipe, setEditingRecipe] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [viewingRecipe, setViewingRecipe] = useState(null);

            const filteredRecipes = recipes.filter(r => 
                r.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (r.keywords && r.keywords.some(k => k.toLowerCase().includes(searchTerm.toLowerCase())))
            );

            const handleExport = () => {
                const dataStr = JSON.stringify(recipes, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'recipes-export.json';
                link.click();
            };

            const handleImport = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    const text = await file.text();
                    try {
                        const imported = JSON.parse(text);
                        
                        for (const recipe of imported) {
                            const { id, ...recipeData } = recipe;
                            await supabase.from('recipes').insert(recipeData);
                        }
                        alert('Recipes imported successfully!');
                        reload();
                    } catch (error) {
                        alert('Error importing recipes. Please check the file format.');
                        console.error(error);
                    }
                };
                input.click();
            };

            const handlePasteImport = () => {
                const text = prompt('Paste your JSON text here:');
                if (!text) return;
                
                try {
                    const imported = JSON.parse(text);
                    
                    (async () => {
                        for (const recipe of imported) {
                            const { id, ...recipeData } = recipe;
                            await supabase.from('recipes').insert(recipeData);
                        }
                        alert('Recipes imported successfully!');
                        reload();
                    })();
                } catch (error) {
                    alert('Error importing recipes. Please check the JSON format.');
                    console.error(error);
                }
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Recipes</h1>
                        <p className="page-subtitle">Manage your recipe collection</p>
                    </div>

                    <div className="search-bar">
                        <span className="search-icon">üîç</span>
                        <input 
                            type="text"
                            className="search-input"
                            placeholder="Search recipes by name or keywords..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    <div className="action-buttons">
                        <button className="btn btn-primary" onClick={() => {
                            setEditingRecipe(null);
                            setShowModal(true);
                        }}>
                            ‚ûï Add Recipe
                        </button>
                        <button className="btn btn-secondary" onClick={handleImport}>
                            üì• Import File
                        </button>
                        <button className="btn btn-secondary" onClick={handlePasteImport}>
                            üìã Paste JSON
                        </button>
                        <button className="btn btn-secondary" onClick={handleExport}>
                            üì§ Export
                        </button>
                    </div>

                    <div className="recipe-grid">
                        {filteredRecipes.map(recipe => (
                            <div 
                                key={recipe.id} 
                                className="recipe-card"
                                onClick={() => setViewingRecipe(recipe)}
                            >
                                {recipe.image_url ? (
                                    <img src={recipe.image_url} alt={recipe.name} className="recipe-image" />
                                ) : (
                                    <div className="recipe-image" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '3rem' }}>
                                        üçΩÔ∏è
                                    </div>
                                )}
                                <div className="recipe-content">
                                    <h3 className="recipe-name">{recipe.name}</h3>
                                    <div className="recipe-meta">
                                        {recipe.prep_time && <span>‚è±Ô∏è {recipe.prep_time} min</span>}
                                        {recipe.nutrition?.calories && <span>üî• {recipe.nutrition.calories} cal</span>}
                                    </div>
                                    {recipe.collections && recipe.collections.length > 0 && (
                                        <div style={{ marginTop: '0.5rem' }}>
                                            {recipe.collections.map((col, idx) => (
                                                <span key={idx} className="badge badge-primary">{col}</span>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {showModal && (
                        <RecipeModal 
                            recipe={editingRecipe}
                            onClose={() => setShowModal(false)}
                            onSave={reload}
                        />
                    )}

                    {viewingRecipe && (
                        <RecipeDetailModal 
                            recipe={viewingRecipe}
                            onClose={() => setViewingRecipe(null)}
                            onEdit={() => {
                                setEditingRecipe(viewingRecipe);
                                setViewingRecipe(null);
                                setShowModal(true);
                            }}
                            onDelete={async () => {
                                await supabase.from('recipes').delete().eq('id', viewingRecipe.id);
                                setViewingRecipe(null);
                                reload();
                            }}
                            reloadMealPlans={reloadMealPlans}
                        />
                    )}
                </div>
            );
        }

        // Recipe Modal Component
        function RecipeModal({ recipe, onClose, onSave }) {
            const [formData, setFormData] = useState(recipe || {
                name: '',
                servings: 1,
                prep_time: null,
                cook_time: null,
                source: '',
                image_url: '',
                collections: [],
                keywords: [],
                ingredients: [],
                steps: [],
                notes: '',
                nutrition: { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0, sugar: 0 },
                is_simple: false
            });

            const handleSave = async () => {
                try {
                    console.log('Attempting to save recipe:', formData);
                    
                    // Sanitize data to ensure proper types
                    const sanitizedData = {
                        ...formData,
                        servings: parseInt(formData.servings) || 1,
                        prep_time: formData.prep_time ? parseInt(formData.prep_time) : null,
                        cook_time: formData.cook_time ? parseInt(formData.cook_time) : null,
                        collections: Array.isArray(formData.collections) ? formData.collections : [],
                        keywords: Array.isArray(formData.keywords) ? formData.keywords : [],
                        ingredients: Array.isArray(formData.ingredients) ? formData.ingredients : [],
                        steps: Array.isArray(formData.steps) ? formData.steps : [],
                        nutrition: {
                            calories: parseFloat(formData.nutrition?.calories) || 0,
                            protein: parseFloat(formData.nutrition?.protein) || 0,
                            carbs: parseFloat(formData.nutrition?.carbs) || 0,
                            fat: parseFloat(formData.nutrition?.fat) || 0,
                            fiber: parseFloat(formData.nutrition?.fiber) || 0,
                            sugar: parseFloat(formData.nutrition?.sugar) || 0
                        },
                        is_simple: Boolean(formData.is_simple)
                    };
                    
                    console.log('Sanitized data:', sanitizedData);
                    
                    if (recipe) {
                        // Update existing recipe
                        const { data, error } = await supabase
                            .from('recipes')
                            .update(sanitizedData)
                            .eq('id', recipe.id)
                            .select();
                        
                        if (error) {
                            console.error('Error updating recipe:', error);
                            alert(`Error updating recipe: ${error.message}`);
                            return;
                        }
                        console.log('Recipe updated successfully:', data);
                    } else {
                        // Insert new recipe
                        const { data, error } = await supabase
                            .from('recipes')
                            .insert(sanitizedData)
                            .select();
                        
                        if (error) {
                            console.error('Error inserting recipe:', error);
                            alert(`Error saving recipe: ${error.message}`);
                            return;
                        }
                        console.log('Recipe inserted successfully:', data);
                    }
                    
                    onSave();
                    onClose();
                } catch (err) {
                    console.error('Exception saving recipe:', err);
                    alert(`Exception: ${err.message}`);
                }
            };

            const addIngredient = () => {
                setFormData({
                    ...formData,
                    ingredients: [...formData.ingredients, { item: '', amount: '' }]
                });
            };

            const addStep = () => {
                setFormData({
                    ...formData,
                    steps: [...formData.steps, '']
                });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{recipe ? 'Edit Recipe' : 'Add Recipe'}</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="simple-recipe-toggle">
                            <div 
                                className={`toggle-switch ${formData.is_simple ? 'active' : ''}`}
                                onClick={() => setFormData({ ...formData, is_simple: !formData.is_simple })}
                            >
                                <div className="toggle-slider"></div>
                            </div>
                            <span>Simple meal entry (no ingredients/steps needed)</span>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Recipe Name *</label>
                                <input 
                                    className="input-field"
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Servings</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.servings}
                                    onChange={(e) => setFormData({ ...formData, servings: parseInt(e.target.value) })}
                                />
                            </div>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Prep Time (min)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.prep_time}
                                    onChange={(e) => setFormData({ ...formData, prep_time: e.target.value })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Cook Time (min)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.cook_time}
                                    onChange={(e) => setFormData({ ...formData, cook_time: e.target.value })}
                                />
                            </div>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Image URL</label>
                            <input 
                                className="input-field"
                                value={formData.image_url}
                                onChange={(e) => setFormData({ ...formData, image_url: e.target.value })}
                            />
                        </div>

                        <div className="input-group">
                            <label className="input-label">Source</label>
                            <input 
                                className="input-field"
                                value={formData.source}
                                onChange={(e) => setFormData({ ...formData, source: e.target.value })}
                            />
                        </div>

                        <div className="input-group">
                            <label className="input-label">Collections (comma-separated)</label>
                            <input 
                                className="input-field"
                                value={formData.collections?.join(', ') || ''}
                                onChange={(e) => setFormData({ 
                                    ...formData, 
                                    collections: e.target.value.split(',').map(s => s.trim()).filter(Boolean)
                                })}
                            />
                        </div>

                        <div className="input-group">
                            <label className="input-label">Keywords (comma-separated)</label>
                            <input 
                                className="input-field"
                                value={formData.keywords?.join(', ') || ''}
                                onChange={(e) => setFormData({ 
                                    ...formData, 
                                    keywords: e.target.value.split(',').map(s => s.trim()).filter(Boolean)
                                })}
                            />
                        </div>

                        <h3 style={{ marginTop: '1.5rem', marginBottom: '1rem' }}>Nutrition (per serving)</h3>
                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Calories</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.nutrition?.calories || 0}
                                    onChange={(e) => setFormData({ 
                                        ...formData, 
                                        nutrition: { ...formData.nutrition, calories: parseFloat(e.target.value) || 0 }
                                    })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Protein (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.nutrition?.protein || 0}
                                    onChange={(e) => setFormData({ 
                                        ...formData, 
                                        nutrition: { ...formData.nutrition, protein: parseFloat(e.target.value) || 0 }
                                    })}
                                />
                            </div>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Carbs (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.nutrition?.carbs || 0}
                                    onChange={(e) => setFormData({ 
                                        ...formData, 
                                        nutrition: { ...formData.nutrition, carbs: parseFloat(e.target.value) || 0 }
                                    })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Fat (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.nutrition?.fat || 0}
                                    onChange={(e) => setFormData({ 
                                        ...formData, 
                                        nutrition: { ...formData.nutrition, fat: parseFloat(e.target.value) || 0 }
                                    })}
                                />
                            </div>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Fiber (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.nutrition?.fiber || 0}
                                    onChange={(e) => setFormData({ 
                                        ...formData, 
                                        nutrition: { ...formData.nutrition, fiber: parseFloat(e.target.value) || 0 }
                                    })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Sugar (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.nutrition?.sugar || 0}
                                    onChange={(e) => setFormData({ 
                                        ...formData, 
                                        nutrition: { ...formData.nutrition, sugar: parseFloat(e.target.value) || 0 }
                                    })}
                                />
                            </div>
                        </div>

                        {!formData.is_simple && (
                            <>
                                <h3 style={{ marginTop: '1.5rem', marginBottom: '1rem' }}>Ingredients</h3>
                                {formData.ingredients?.map((ing, idx) => (
                                    <div key={idx} className="form-row" style={{ marginBottom: '0.5rem' }}>
                                        <input 
                                            className="input-field"
                                            placeholder="Amount"
                                            value={ing.amount}
                                            onChange={(e) => {
                                                const newIngs = [...formData.ingredients];
                                                newIngs[idx].amount = e.target.value;
                                                setFormData({ ...formData, ingredients: newIngs });
                                            }}
                                        />
                                        <input 
                                            className="input-field"
                                            placeholder="Item"
                                            value={ing.item}
                                            onChange={(e) => {
                                                const newIngs = [...formData.ingredients];
                                                newIngs[idx].item = e.target.value;
                                                setFormData({ ...formData, ingredients: newIngs });
                                            }}
                                        />
                                    </div>
                                ))}
                                <button className="btn btn-secondary" onClick={addIngredient} style={{ marginTop: '0.5rem' }}>
                                    + Add Ingredient
                                </button>

                                <h3 style={{ marginTop: '1.5rem', marginBottom: '1rem' }}>Steps</h3>
                                {formData.steps?.map((step, idx) => (
                                    <div key={idx} className="input-group">
                                        <textarea 
                                            className="input-field"
                                            placeholder={`Step ${idx + 1}`}
                                            value={step}
                                            onChange={(e) => {
                                                const newSteps = [...formData.steps];
                                                newSteps[idx] = e.target.value;
                                                setFormData({ ...formData, steps: newSteps });
                                            }}
                                        />
                                    </div>
                                ))}
                                <button className="btn btn-secondary" onClick={addStep}>
                                    + Add Step
                                </button>
                            </>
                        )}

                        <div className="input-group" style={{ marginTop: '1.5rem' }}>
                            <label className="input-label">Notes</label>
                            <textarea 
                                className="input-field"
                                value={formData.notes}
                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                            />
                        </div>

                        <div className="action-buttons">
                            <button className="btn btn-primary" onClick={handleSave}>
                                Save Recipe
                            </button>
                            <button className="btn btn-secondary" onClick={onClose}>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Recipe Detail Modal Component
        function RecipeDetailModal({ recipe, onClose, onEdit, onDelete, reloadMealPlans }) {
            const [servings, setServings] = useState(recipe.servings || 1);
            const [showMealPlanSelector, setShowMealPlanSelector] = useState(false);

            const scaleAmount = (amount) => {
                const multiplier = servings / (recipe.servings || 1);
                const match = amount.match(/(\d+\.?\d*)/);
                if (match) {
                    const num = parseFloat(match[1]);
                    const scaled = (num * multiplier).toFixed(2).replace(/\.?0+$/, '');
                    return amount.replace(match[1], scaled);
                }
                return amount;
            };

            const handlePrint = () => {
                // Create a new window for printing
                const printWindow = window.open('', '', 'width=800,height=600');
                
                // Build the print content
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${recipe.name}</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { 
                                font-family: 'Arial', sans-serif; 
                                padding: 0.8cm; 
                                max-width: 19cm;
                                margin: 0 auto;
                                color: #000;
                                font-size: 9pt;
                            }
                            h1 { 
                                font-size: 1.3rem; 
                                margin-bottom: 0.3cm; 
                                color: #1a5f3d;
                            }
                            .meta { 
                                font-size: 0.85rem; 
                                color: #666; 
                                margin-bottom: 0.3cm; 
                            }
                            .meta span { margin-right: 1rem; }
                            img { 
                                max-width: 6cm; 
                                max-height: 5cm; 
                                display: block; 
                                margin: 0 auto 0.3cm; 
                            }
                            .nutrition { 
                                background: #f5f5f5; 
                                padding: 0.3cm; 
                                margin-bottom: 0.4cm; 
                                border-radius: 4px;
                                page-break-inside: avoid;
                            }
                            .nutrition h3 { 
                                font-size: 0.95rem; 
                                margin-bottom: 0.2cm; 
                            }
                            .nutrition-grid { 
                                display: grid; 
                                grid-template-columns: repeat(auto-fit, minmax(2.5cm, 1fr)); 
                                gap: 0.2cm; 
                            }
                            .nutrition-item { 
                                background: white; 
                                padding: 0.2cm; 
                                text-align: center; 
                                border-radius: 4px;
                            }
                            .nutrition-value { 
                                font-size: 1.1rem; 
                                font-weight: bold; 
                                color: #1a5f3d; 
                            }
                            .nutrition-label { 
                                font-size: 0.75rem; 
                                color: #666; 
                            }
                            h3 { 
                                font-size: 1.1rem; 
                                margin-top: 0.4cm; 
                                margin-bottom: 0.25cm; 
                                color: #1a5f3d;
                            }
                            ul { 
                                padding-left: 0.7cm; 
                                margin-bottom: 0.4cm; 
                            }
                            ol { 
                                padding-left: 0.7cm; 
                                margin-bottom: 0.3cm; 
                            }
                            li { 
                                padding: 0.1cm 0; 
                                border-bottom: 0.5px solid #ddd; 
                                line-height: 1.3;
                                font-size: 0.9rem;
                            }
                            ul li:last-child,
                            ol li:last-child {
                                border-bottom: none;
                            }
                            ol li { 
                                margin-bottom: 0.25cm; 
                                border-bottom: none;
                            }
                            .notes { 
                                color: #666; 
                                line-height: 1.3; 
                                font-size: 0.85rem;
                                margin-top: 0.3cm;
                                page-break-inside: avoid;
                            }
                            .notes h3 {
                                margin-top: 0.3cm;
                            }
                            @page { 
                                size: A4 portrait; 
                                margin: 1cm; 
                            }
                            @media print {
                                body { padding: 0; }
                                .nutrition,
                                .notes {
                                    page-break-inside: avoid;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${recipe.name}</h1>
                        
                        <div class="meta">
                            ${recipe.prep_time ? `<span>‚è±Ô∏è Prep: ${recipe.prep_time} min</span>` : ''}
                            ${recipe.cook_time ? `<span>üç≥ Cook: ${recipe.cook_time} min</span>` : ''}
                            ${recipe.source ? `<span>üìö ${recipe.source}</span>` : ''}
                        </div>
                        
                        ${recipe.image_url ? `<img src="${recipe.image_url}" alt="${recipe.name}">` : ''}
                        
                        ${recipe.nutrition ? `
                            <div class="nutrition">
                                <h3>Nutrition (per serving)</h3>
                                <div class="nutrition-grid">
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${recipe.nutrition.calories}</div>
                                        <div class="nutrition-label">Calories</div>
                                    </div>
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${recipe.nutrition.protein}g</div>
                                        <div class="nutrition-label">Protein</div>
                                    </div>
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${recipe.nutrition.carbs}g</div>
                                        <div class="nutrition-label">Carbs</div>
                                    </div>
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${recipe.nutrition.fat}g</div>
                                        <div class="nutrition-label">Fat</div>
                                    </div>
                                    ${recipe.nutrition.fiber > 0 ? `
                                        <div class="nutrition-item">
                                            <div class="nutrition-value">${recipe.nutrition.fiber}g</div>
                                            <div class="nutrition-label">Fiber</div>
                                        </div>
                                    ` : ''}
                                    ${recipe.nutrition.sugar > 0 ? `
                                        <div class="nutrition-item">
                                            <div class="nutrition-value">${recipe.nutrition.sugar}g</div>
                                            <div class="nutrition-label">Sugar</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${!recipe.is_simple && recipe.ingredients && recipe.ingredients.length > 0 ? `
                            <h3>Ingredients (${servings} servings)</h3>
                            <ul>
                                ${recipe.ingredients.map(ing => `
                                    <li><strong>${scaleAmount(ing.amount)}</strong> ${ing.item}</li>
                                `).join('')}
                            </ul>
                        ` : ''}
                        
                        ${recipe.notes ? `
                            <div class="notes">
                                <h3>Notes</h3>
                                <p>${recipe.notes}</p>
                            </div>
                        ` : ''}
                        
                        ${!recipe.is_simple && recipe.steps && recipe.steps.length > 0 ? `
                            <h3>Instructions</h3>
                            <ol>
                                ${recipe.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        ` : ''}
                    </body>
                    </html>
                `;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // Wait for content to load, then print
                printWindow.onload = function() {
                    printWindow.print();
                    printWindow.onafterprint = function() {
                        printWindow.close();
                    };
                };
            };

            const addToMealPlan = async (date, mealType) => {
                await supabase.from('meal_plans').insert({
                    date: formatDate(date),
                    meal_type: mealType,
                    data_type: 'recipe',
                    recipe_id: recipe.id,
                    custom_text: null
                });
                alert(`Added ${recipe.name} to ${mealType} on ${getDayName(date)}`);
                setShowMealPlanSelector(false);
                // Reload meal plans if the function is provided
                if (reloadMealPlans) {
                    reloadMealPlans();
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal recipe-print-view" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{recipe.name}</h2>
                            <button className="close-btn" onClick={onClose} style={{ fontSize: '2rem', padding: '0.5rem' }}>‚úï</button>
                        </div>

                        <div className="action-buttons" style={{ marginTop: 0, marginBottom: '1rem' }}>
                            <button className="btn btn-secondary" onClick={(e) => {
                                e.stopPropagation();
                                onClose();
                            }} style={{ width: '100%' }}>
                                ‚Üê Back to Recipes
                            </button>
                        </div>

                        {recipe.image_url && (
                            <img src={recipe.image_url} alt={recipe.name} style={{ width: '100%', borderRadius: '8px', marginBottom: '1rem' }} />
                        )}

                        <div className="recipe-meta" style={{ fontSize: '1rem', marginBottom: '1rem' }}>
                            {recipe.prep_time && <span>‚è±Ô∏è Prep: {recipe.prep_time} min</span>}
                            {recipe.cook_time && <span>üç≥ Cook: {recipe.cook_time} min</span>}
                            {recipe.source && <span>üìö {recipe.source}</span>}
                        </div>

                        {recipe.nutrition && (
                            <div className="card" style={{ marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>Nutrition (per serving)</h3>
                                <div className="nutrition-summary">
                                    <div className="nutrition-item">
                                        <div className="nutrition-value">{recipe.nutrition.calories}</div>
                                        <div className="nutrition-label">Calories</div>
                                    </div>
                                    <div className="nutrition-item">
                                        <div className="nutrition-value">{recipe.nutrition.protein}g</div>
                                        <div className="nutrition-label">Protein</div>
                                    </div>
                                    <div className="nutrition-item">
                                        <div className="nutrition-value">{recipe.nutrition.carbs}g</div>
                                        <div className="nutrition-label">Carbs</div>
                                    </div>
                                    <div className="nutrition-item">
                                        <div className="nutrition-value">{recipe.nutrition.fat}g</div>
                                        <div className="nutrition-label">Fat</div>
                                    </div>
                                    {recipe.nutrition.fiber > 0 && (
                                        <div className="nutrition-item">
                                            <div className="nutrition-value">{recipe.nutrition.fiber}g</div>
                                            <div className="nutrition-label">Fiber</div>
                                        </div>
                                    )}
                                    {recipe.nutrition.sugar > 0 && (
                                        <div className="nutrition-item">
                                            <div className="nutrition-value">{recipe.nutrition.sugar}g</div>
                                            <div className="nutrition-label">Sugar</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {!recipe.is_simple && recipe.ingredients && recipe.ingredients.length > 0 && (
                            <div className="ingredients-section" style={{ marginBottom: '1.5rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <h3>Ingredients</h3>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <label>Servings:</label>
                                        <input 
                                            type="number"
                                            value={servings}
                                            onChange={(e) => setServings(parseInt(e.target.value) || 1)}
                                            style={{ width: '60px', padding: '0.25rem', borderRadius: '4px', border: '2px solid var(--border)' }}
                                        />
                                    </div>
                                </div>
                                <ul style={{ listStyle: 'none' }}>
                                    {recipe.ingredients.map((ing, idx) => (
                                        <li key={idx} style={{ padding: '0.5rem 0', borderBottom: '1px solid var(--border)' }}>
                                            <strong>{scaleAmount(ing.amount)}</strong> {ing.item}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {!recipe.is_simple && recipe.steps && recipe.steps.length > 0 && (
                            <div className="steps-section" style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ marginBottom: '1rem' }}>Instructions</h3>
                                <ol style={{ paddingLeft: '1.5rem' }}>
                                    {recipe.steps.map((step, idx) => (
                                        <li key={idx} style={{ marginBottom: '1rem' }}>{step}</li>
                                    ))}
                                </ol>
                            </div>
                        )}

                        {recipe.notes && (
                            <div style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>Notes</h3>
                                <p style={{ color: 'var(--text-light)' }}>{recipe.notes}</p>
                            </div>
                        )}

                        <div className="action-buttons">
                            <button className="btn btn-accent" onClick={(e) => {
                                e.stopPropagation();
                                setShowMealPlanSelector(true);
                            }}>
                                üìÖ Add to Meal Plan
                            </button>
                            <button className="btn btn-primary" onClick={(e) => {
                                e.stopPropagation();
                                onEdit();
                            }}>
                                ‚úèÔ∏è Edit
                            </button>
                            <button className="btn btn-secondary" onClick={(e) => {
                                e.stopPropagation();
                                handlePrint();
                            }}>
                                üñ®Ô∏è Print
                            </button>
                            <button className="btn btn-secondary" onClick={(e) => {
                                e.stopPropagation();
                                onDelete();
                            }} style={{ background: 'var(--error)', color: 'white' }}>
                                üóëÔ∏è Delete
                            </button>
                        </div>

                        {showMealPlanSelector && (
                            <MealPlanSelectorModal 
                                recipeName={recipe.name}
                                onSelect={addToMealPlan}
                                onClose={() => setShowMealPlanSelector(false)}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Meal Planning Component
        function MealPlanning({ recipes, mealPlans, reload }) {
            const [selectedDate, setSelectedDate] = useState(null);
            const [selectedMealType, setSelectedMealType] = useState(null);
            const [showRecipeSelector, setShowRecipeSelector] = useState(false);
            const [customText, setCustomText] = useState('');
            const [showExtrasModal, setShowExtrasModal] = useState(false);

            const dates = getNextTwoWeeks();

            const getMealsForDate = (date) => {
                const dateStr = formatDate(date);
                return mealPlans.filter(mp => mp.date === dateStr);
            };

            const addMeal = async (date, mealType, recipeId, customText) => {
                await supabase.from('meal_plans').insert({
                    date: formatDate(date),
                    meal_type: mealType,
                    data_type: recipeId ? 'recipe' : 'custom',
                    recipe_id: recipeId,
                    custom_text: customText
                });
                reload();
                setShowRecipeSelector(false);
                setCustomText('');
            };

            const deleteMeal = async (mealId) => {
                await supabase.from('meal_plans').delete().eq('id', mealId);
                reload();
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Meal Planning</h1>
                        <p className="page-subtitle">Plan your meals for the next 2 weeks</p>
                    </div>

                    <div className="meal-plan-grid">
                        {dates.map((date, idx) => {
                            const meals = getMealsForDate(date);
                            const breakfast = meals.find(m => m.meal_type === 'breakfast');
                            const lunch = meals.find(m => m.meal_type === 'lunch');
                            const dinner = meals.find(m => m.meal_type === 'dinner');

                            return (
                                <div key={idx} className="day-card">
                                    <div className="day-header">{getDayName(date)}</div>
                                    
                                    <div className="meal-slot">
                                        <div className="meal-type">Breakfast</div>
                                        {breakfast ? (
                                            <div>
                                                <div style={{ fontWeight: '600' }}>
                                                    {breakfast.data_type === 'recipe' 
                                                        ? recipes.find(r => r.id === breakfast.recipe_id)?.name 
                                                        : breakfast.custom_text}
                                                </div>
                                                <button 
                                                    className="btn btn-secondary" 
                                                    onClick={() => deleteMeal(breakfast.id)}
                                                    style={{ marginTop: '0.5rem', padding: '0.25rem 0.75rem', fontSize: '0.85rem' }}
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        ) : (
                                            <button 
                                                className="btn btn-primary" 
                                                onClick={() => {
                                                    setSelectedDate(date);
                                                    setSelectedMealType('breakfast');
                                                    setShowRecipeSelector(true);
                                                }}
                                                style={{ padding: '0.5rem 1rem', fontSize: '0.85rem' }}
                                            >
                                                + Add Meal
                                            </button>
                                        )}
                                    </div>

                                    <div className="meal-slot">
                                        <div className="meal-type">Lunch</div>
                                        {lunch ? (
                                            <div>
                                                <div style={{ fontWeight: '600' }}>
                                                    {lunch.data_type === 'recipe' 
                                                        ? recipes.find(r => r.id === lunch.recipe_id)?.name 
                                                        : lunch.custom_text}
                                                </div>
                                                <button 
                                                    className="btn btn-secondary" 
                                                    onClick={() => deleteMeal(lunch.id)}
                                                    style={{ marginTop: '0.5rem', padding: '0.25rem 0.75rem', fontSize: '0.85rem' }}
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        ) : (
                                            <button 
                                                className="btn btn-primary" 
                                                onClick={() => {
                                                    setSelectedDate(date);
                                                    setSelectedMealType('lunch');
                                                    setShowRecipeSelector(true);
                                                }}
                                                style={{ padding: '0.5rem 1rem', fontSize: '0.85rem' }}
                                            >
                                                + Add Meal
                                            </button>
                                        )}
                                    </div>

                                    <div className="meal-slot">
                                        <div className="meal-type">Dinner</div>
                                        {dinner ? (
                                            <div>
                                                <div style={{ fontWeight: '600' }}>
                                                    {dinner.data_type === 'recipe' 
                                                        ? recipes.find(r => r.id === dinner.recipe_id)?.name 
                                                        : dinner.custom_text}
                                                </div>
                                                <button 
                                                    className="btn btn-secondary" 
                                                    onClick={() => deleteMeal(dinner.id)}
                                                    style={{ marginTop: '0.5rem', padding: '0.25rem 0.75rem', fontSize: '0.85rem' }}
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        ) : (
                                            <button 
                                                className="btn btn-primary" 
                                                onClick={() => {
                                                    setSelectedDate(date);
                                                    setSelectedMealType('dinner');
                                                    setShowRecipeSelector(true);
                                                }}
                                                style={{ padding: '0.5rem 1rem', fontSize: '0.85rem' }}
                                            >
                                                + Add Meal
                                            </button>
                                        )}
                                    </div>

                                    <button 
                                        className="btn btn-accent" 
                                        onClick={() => {
                                            setSelectedDate(date);
                                            setShowExtrasModal(true);
                                        }}
                                        style={{ marginTop: '1rem', width: '100%', padding: '0.5rem' }}
                                    >
                                        + Add Daily Extras
                                    </button>
                                </div>
                            );
                        })}
                    </div>

                    {showRecipeSelector && (
                        <RecipeSelectorModal 
                            recipes={recipes}
                            onSelect={(recipeId) => addMeal(selectedDate, selectedMealType, recipeId, null)}
                            onCustom={(text) => addMeal(selectedDate, selectedMealType, null, text)}
                            onClose={() => setShowRecipeSelector(false)}
                        />
                    )}

                    {showExtrasModal && (
                        <DailyExtrasModal 
                            date={selectedDate}
                            onClose={() => {
                                setShowExtrasModal(false);
                                reload();
                            }}
                        />
                    )}
                </div>
            );
        }

        // Recipe Selector Modal
        function RecipeSelectorModal({ recipes, onSelect, onCustom, onClose }) {
            const [customText, setCustomText] = useState('');
            const [searchTerm, setSearchTerm] = useState('');

            const filteredRecipes = recipes.filter(r => 
                r.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Select Recipe or Add Custom</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Custom Entry (e.g., "Eating out")</label>
                            <input 
                                className="input-field"
                                value={customText}
                                onChange={(e) => setCustomText(e.target.value)}
                                placeholder="Enter custom meal text"
                            />
                            <button 
                                className="btn btn-primary" 
                                onClick={() => onCustom(customText)}
                                disabled={!customText}
                                style={{ marginTop: '0.5rem' }}
                            >
                                Add Custom Entry
                            </button>
                        </div>

                        <div style={{ margin: '1.5rem 0', borderTop: '2px solid var(--border)', paddingTop: '1.5rem' }}>
                            <h3 style={{ marginBottom: '1rem' }}>Or select a recipe:</h3>
                            <input 
                                className="input-field"
                                placeholder="Search recipes..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            <div style={{ maxHeight: '300px', overflowY: 'auto', marginTop: '1rem' }}>
                                {filteredRecipes.map(recipe => (
                                    <div 
                                        key={recipe.id}
                                        className="quick-food-item"
                                        onClick={() => onSelect(recipe.id)}
                                        style={{ cursor: 'pointer' }}
                                    >
                                        <div>
                                            <div style={{ fontWeight: '600' }}>{recipe.name}</div>
                                            {recipe.nutrition && (
                                                <div style={{ fontSize: '0.85rem', color: 'var(--text-light)' }}>
                                                    {recipe.nutrition.calories} cal, {recipe.nutrition.protein}g protein
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Meal Plan Selector Modal Component
        function MealPlanSelectorModal({ recipeName, onSelect, onClose }) {
            const [selectedDate, setSelectedDate] = useState(null);
            const [selectedMealType, setSelectedMealType] = useState(null);
            const dates = getNextTwoWeeks();

            const handleSelect = () => {
                if (selectedDate && selectedMealType) {
                    onSelect(selectedDate, selectedMealType);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
                        <div className="modal-header">
                            <h2 className="modal-title">Add "{recipeName}" to Meal Plan</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Select Date</label>
                            <select 
                                className="input-field"
                                value={selectedDate ? formatDate(selectedDate) : ''}
                                onChange={(e) => {
                                    const date = dates.find(d => formatDate(d) === e.target.value);
                                    setSelectedDate(date);
                                }}
                            >
                                <option value="">Choose a date...</option>
                                {dates.map((date, idx) => (
                                    <option key={idx} value={formatDate(date)}>
                                        {getDayName(date)}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Select Meal Type</label>
                            <select 
                                className="input-field"
                                value={selectedMealType || ''}
                                onChange={(e) => setSelectedMealType(e.target.value)}
                            >
                                <option value="">Choose meal type...</option>
                                <option value="breakfast">Breakfast</option>
                                <option value="lunch">Lunch</option>
                                <option value="dinner">Dinner</option>
                            </select>
                        </div>

                        <div className="action-buttons">
                            <button 
                                className="btn btn-primary" 
                                onClick={handleSelect}
                                disabled={!selectedDate || !selectedMealType}
                            >
                                Add to Meal Plan
                            </button>
                            <button className="btn btn-secondary" onClick={onClose}>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Daily Extras Modal
        function DailyExtrasModal({ date, onClose }) {
            const [extras, setExtras] = useState([]);
            const [name, setName] = useState('');
            const [calories, setCalories] = useState('');
            const [protein, setProtein] = useState('');

            useEffect(() => {
                loadExtras();
            }, []);

            const loadExtras = async () => {
                const { data } = await supabase
                    .from('daily_extras')
                    .select('*')
                    .eq('date', formatDate(date));
                if (data) setExtras(data);
            };

            const addExtra = async () => {
                await supabase.from('daily_extras').insert({
                    date: formatDate(date),
                    name,
                    calories: parseFloat(calories) || 0,
                    protein: parseFloat(protein) || 0
                });
                setName('');
                setCalories('');
                setProtein('');
                loadExtras();
            };

            const deleteExtra = async (id) => {
                await supabase.from('daily_extras').delete().eq('id', id);
                loadExtras();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Daily Extras - {getDayName(date)}</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Item Name</label>
                            <input 
                                className="input-field"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="e.g., Coffee, Snack"
                            />
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Calories</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={calories}
                                    onChange={(e) => setCalories(e.target.value)}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Protein (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={protein}
                                    onChange={(e) => setProtein(e.target.value)}
                                />
                            </div>
                        </div>

                        <button className="btn btn-primary" onClick={addExtra} disabled={!name}>
                            Add Extra
                        </button>

                        <div style={{ marginTop: '1.5rem' }}>
                            <h3 style={{ marginBottom: '1rem' }}>Added Extras</h3>
                            {extras.map(extra => (
                                <div key={extra.id} className="quick-food-item">
                                    <div>
                                        <div style={{ fontWeight: '600' }}>{extra.name}</div>
                                        <div style={{ fontSize: '0.85rem', color: 'var(--text-light)' }}>
                                            {extra.calories} cal, {extra.protein}g protein
                                        </div>
                                    </div>
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => deleteExtra(extra.id)}
                                        style={{ padding: '0.25rem 0.75rem', fontSize: '0.85rem' }}
                                    >
                                        Remove
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Quick Foods Component
        function QuickFoods({ quickFoods, reload }) {
            const [showModal, setShowModal] = useState(false);
            const [editingFood, setEditingFood] = useState(null);

            const deleteFood = async (id) => {
                await supabase.from('quick_foods').delete().eq('id', id);
                reload();
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Quick Foods</h1>
                        <p className="page-subtitle">Manage frequently used snacks and beverages</p>
                    </div>

                    <button className="btn btn-primary" onClick={() => {
                        setEditingFood(null);
                        setShowModal(true);
                    }}>
                        ‚ûï Add Quick Food
                    </button>

                    <div style={{ marginTop: '1.5rem' }}>
                        {quickFoods.map(food => (
                            <div key={food.id} className="quick-food-item">
                                <div>
                                    <div style={{ fontWeight: '600', fontSize: '1.1rem' }}>{food.name}</div>
                                    <div style={{ fontSize: '0.9rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                        {food.calories} cal | {food.protein}g protein | {food.carbs}g carbs | {food.fat}g fat
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => {
                                            setEditingFood(food);
                                            setShowModal(true);
                                        }}
                                        style={{ padding: '0.5rem 1rem' }}
                                    >
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => deleteFood(food.id)}
                                        style={{ padding: '0.5rem 1rem', background: 'var(--error)', color: 'white' }}
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {showModal && (
                        <QuickFoodModal 
                            food={editingFood}
                            onClose={() => setShowModal(false)}
                            onSave={reload}
                        />
                    )}
                </div>
            );
        }

        // Quick Food Modal
        function QuickFoodModal({ food, onClose, onSave }) {
            const [formData, setFormData] = useState(food || {
                name: '',
                calories: 0,
                protein: 0,
                carbs: 0,
                fat: 0
            });

            const handleSave = async () => {
                if (food) {
                    await supabase.from('quick_foods').update(formData).eq('id', food.id);
                } else {
                    await supabase.from('quick_foods').insert(formData);
                }
                onSave();
                onClose();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{food ? 'Edit Quick Food' : 'Add Quick Food'}</h2>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Name</label>
                            <input 
                                className="input-field"
                                value={formData.name}
                                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                            />
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Calories</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.calories}
                                    onChange={(e) => setFormData({ ...formData, calories: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Protein (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.protein}
                                    onChange={(e) => setFormData({ ...formData, protein: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Carbs (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.carbs}
                                    onChange={(e) => setFormData({ ...formData, carbs: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Fat (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.fat}
                                    onChange={(e) => setFormData({ ...formData, fat: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                        </div>

                        <div className="action-buttons">
                            <button className="btn btn-primary" onClick={handleSave}>
                                Save
                            </button>
                            <button className="btn btn-secondary" onClick={onClose}>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Shopping List Component
        function ShoppingList({ recipes, mealPlans }) {
            const [checkedItems, setCheckedItems] = useState(new Set());

            const generateShoppingList = () => {
                const ingredients = {};
                const dates = getNextTwoWeeks();

                mealPlans.forEach(mp => {
                    if (mp.data_type === 'recipe' && mp.recipe_id) {
                        const recipe = recipes.find(r => r.id === mp.recipe_id);
                        if (recipe && recipe.ingredients) {
                            recipe.ingredients.forEach(ing => {
                                const key = ing.item.toLowerCase();
                                if (ingredients[key]) {
                                    ingredients[key].amount += ` + ${ing.amount}`;
                                } else {
                                    ingredients[key] = { item: ing.item, amount: ing.amount };
                                }
                            });
                        }
                    }
                });

                return Object.values(ingredients);
            };

            const shoppingList = generateShoppingList();

            const toggleItem = (item) => {
                const newChecked = new Set(checkedItems);
                if (newChecked.has(item)) {
                    newChecked.delete(item);
                } else {
                    newChecked.add(item);
                }
                setCheckedItems(newChecked);
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Shopping List</h1>
                        <p className="page-subtitle">Generated from your meal plan</p>
                    </div>

                    <div className="card">
                        {shoppingList.length === 0 ? (
                            <p style={{ color: 'var(--text-light)' }}>No ingredients to show. Add recipes to your meal plan first.</p>
                        ) : (
                            <ul className="shopping-list">
                                {shoppingList.map((ing, idx) => (
                                    <li key={idx}>
                                        <input 
                                            type="checkbox"
                                            className="checkbox"
                                            checked={checkedItems.has(ing.item)}
                                            onChange={() => toggleItem(ing.item)}
                                        />
                                        <span style={{ textDecoration: checkedItems.has(ing.item) ? 'line-through' : 'none' }}>
                                            <strong>{ing.amount}</strong> {ing.item}
                                        </span>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
                </div>
            );
        }

        // Nutrition Goals Component
        function NutritionGoals({ goals, reload }) {
            const [formData, setFormData] = useState(goals || {
                calories: 2000,
                protein: 150,
                carbs: 250,
                fat: 65,
                fiber: 30,
                sugar: 50
            });

            const handleSave = async () => {
                if (goals) {
                    await supabase.from('nutrition_goals').update(formData).eq('id', goals.id);
                } else {
                    await supabase.from('nutrition_goals').insert(formData);
                }
                reload();
            };

            return (
                <div>
                    <div className="page-header">
                        <h1 className="page-title">Nutrition Goals</h1>
                        <p className="page-subtitle">Set your daily targets</p>
                    </div>

                    <div className="card" style={{ maxWidth: '600px' }}>
                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Calories</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.calories}
                                    onChange={(e) => setFormData({ ...formData, calories: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Protein (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.protein}
                                    onChange={(e) => setFormData({ ...formData, protein: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Carbs (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.carbs}
                                    onChange={(e) => setFormData({ ...formData, carbs: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Fat (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.fat}
                                    onChange={(e) => setFormData({ ...formData, fat: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label className="input-label">Fiber (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.fiber}
                                    onChange={(e) => setFormData({ ...formData, fiber: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <div className="input-group">
                                <label className="input-label">Sugar (g)</label>
                                <input 
                                    type="number"
                                    className="input-field"
                                    value={formData.sugar}
                                    onChange={(e) => setFormData({ ...formData, sugar: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                        </div>

                        <button className="btn btn-primary" onClick={handleSave} style={{ marginTop: '1rem' }}>
                            Save Goals
                        </button>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
